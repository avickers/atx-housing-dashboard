import loki from 'lokijs'
import LokiIndexedAdapter from 'lokijs/src/loki-indexed-adapter'

const idbAdapter = new LokiIndexedAdapter()

class Loki {
  constructor(db,cfg,cb) {
    if(!cfg) cfg = {}
    this._db = new loki(db, {
      adapter: idbAdapter,
      autoload: cfg.autoload||true,
      autoloadCallback : cb||null,
      autosave: cfg.autosave||false,
      autosaveInterval: cfg.autosaveInterval||6000
    })
  }

  addCollection(name) {
    const coll = this._db.addCollection(name)
    return coll
  }

  getCollection(name) {
    return this._db.getCollection(name)
    ? this._db.getCollection(name)
    : this._db.addCollection(name)
  }

  get() {
    return this._db
  }

  saveDatabase() {
    this._db.saveDatabase()
    return this._db
  }
}

const db = new Promise((res,rej) => {
  const loki = new Loki('ahd',null,() => res(loki))
})
export default db
